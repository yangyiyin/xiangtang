<extend name="Public/base"/>

<block name="body">
	<!--百度webuploader-->
	<link rel="stylesheet" type="text/css" href="__STATIC__/webuploader/webuploader.css">
	<script type="text/javascript" src="__STATIC__/webuploader/webuploader.min.js"></script>
	<div class="g-wrap">
		<!-- 按钮工具栏 -->
		<div class="u-tab">
			<ul class="cc tab-nav">
				<li class="current"><a href="javascript:;">{$title}</a></li>
				<li ><a href="{:U('add_history_overdue_resolve_submit_monthly')}">添加历史数据</a></li>
			</ul>
		</div>
		<!-- 数据表格 -->
		<div class="tab-content table_list">
			<!-- 表单 -->
			<form id="form" action="{:U('')}" method="post" class="form-horizontal">
				<div id="tab">
					<table class="biaoge">
						<tbody>
						<tr>
							<td colspan="9"><span class="title">逾期化解明细报表</span><span> (金额单位 万元)</span></td>

						</tr>
						<tr>

							<td colspan="9">

								{:date('Y')}年{:date('m')}月
							</td>
						</tr>
						<tr>
							<td colspan="4">公司全称:</td>

							<td colspan="5">填表人:</td>

						</tr>

						<tr>
							<td colspan="4">
								<select name="all_name">
									<php>
										$list = $departments;
										$cur = $infos[0]['all_name'];
										foreach($list as $li){
										$selected = ($li == $cur) ? 'selected' : '';
										echo '<option value="'.$li.'" '.$selected.'>'.$li.'</option>';
										}
									</php>
								</select>

							</td>
							<td colspan="5">
								<input type="text" class="input input-medium" name="filler_man" value="{$infos[0]['filler_man']}">
							</td>

						</tr>
						<tr>
							<td colspan="9">明细</td>
						</tr>
						<tr>
							<td>企业名称:</td>
							<td>法人代表或实际控制人:</td>
							<td>企业所属乡镇（街道）:</td>
							<td>逾期贷款金额:</td>
							<td>化解金额:</td>
							<td>备注:</td>
						</tr>
						<volist name="infos" id="vo">
							<tr>
								<td>
									<input type="text" class="input input-xmedium" name="logs1[]" value="{$vo.Enterprise}">
								</td>
								<td>
									<input type="text" class="input input-xmedium" name="logs2[]" value="{$vo.Principal}">
								</td>
								<td>
									<select name="logs3[]">
										<if condition="$vo['area_options']">
											{$vo['area_options']}
											<else/>
											{$area_options}
										</if>
									</select>
								</td>
								<td>
									<input type="text" class="input input-xmedium" name="logs4[]" value="{$vo.Overdue}">
								</td>
								<td>
									<input type="text" class="input input-xmedium" name="logs5[]" value="{$vo.Resolve}">
								</td>

								<td>
									<input type="text" class="input input-xmedium" name="logs6[]" value="{$vo.Remarks}">
								</td>
								<td><a class="btn del_log">删除</a></td>
							</tr>
						</volist>
						<tr class="add_line"><td colspan="9"><a class="btn add_log">添加</a></td></tr>
						</tbody>
					</table>
				</div>






				<div class="btn_wrap">
					<div class="btn_wrap_pd">
						<if condition="$infos[0]['status'] == 0">
							<if condition="$infos[0]['id']">已提交</if><button class="btn submit-btn J_ajax_post" id="submit" type="submit" target-form="form-horizontal"><if condition="$infos[0]['id']">修 改<else/>提 交</if></button>

							<if condition="$infos[0]['id']">
								<a class="u-btn confirm J_ajax_get" href="{:U('submit_verify')}/id/{$infos[0]['id']}/type/overdue/year/{$infos[0]['year']}/month/{$infos[0]['month']}/all_name/{$infos[0]['all_name']}" >提交审核</a>
							</if>
						</if>
						<if condition="$infos[0]['status'] == 2">
							已通过
						</if>
						<if condition="$infos[0]['status'] == 1">
							审核中
						</if>
						<div style="position: fixed;right: 0;bottom: 0px;" id="filePicker">导入excel</div>
					</div>
				</div>
			</form>
		</div>
	</div>
	</div>
	<link href="__STATIC__/datetimepicker/css/datetimepicker.css" rel="stylesheet" type="text/css">
	<php>if(C('COLOR_STYLE')=='blue_color') echo '<link href="__STATIC__/datetimepicker/css/datetimepicker_blue.css" rel="stylesheet" type="text/css">';</php>
	<link href="__STATIC__/datetimepicker/css/dropdown.css" rel="stylesheet" type="text/css">
	<script type="text/javascript" src="__STATIC__/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script type="text/javascript" src="__STATIC__/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
	<script>
		$(document).ready(function() {
			$(document).on('click', '.add_log', function () {
				var add_html = '<tr>'+
						'<td>'+
						'<input type="text" class="input input-xmedium" name="logs1[]">'+
						'</td>'+
						'<td>'+
						'<input type="text" class="input input-xmedium" name="logs2[]">'+
						'</td>'+
						'<td>'+
						'<select name="logs3[]">{$area_options}</select>'+
						'</td>'+
						'<td>'+
						'<input type="text" class="input input-xmedium" name="logs4[]">'+
						'</td>'+
						'<td>'+
						'<input type="text" class="input input-xmedium" name="logs5[]">'+
						'</td>'+

						'<td>'+
						'<input type="text" class="input input-xmedium" name="logs6[]">'+
						'</td>'+
						'<td><a class="btn del_log">删除</a></td>'+
						'</tr>'
				$('.add_line').before(add_html);

				$('.add_line').prev().find("#time-start").datetimepicker({
					format: 'yyyy-mm-dd',
					language:"zh-CN",
					minView:2,
					autoclose:true
				});

				$('.add_line').prev().find("#time-end").datetimepicker({
					format: 'yyyy-mm-dd',
					language:"zh-CN",
					minView:2,
					autoclose:true,
					pickerPosition:'bottom-left'
				});



			});
			$(document).on('click', '.del_log', function () {
				$(this).parents('tr').remove();

			});

			$('.time-start').datetimepicker({
				format: 'yyyy-mm-dd',
				language:"zh-CN",
				minView:2,
				autoclose:true
			});
			$('.time-end').datetimepicker({
				format: 'yyyy-mm-dd',
				language:"zh-CN",
				minView:2,
				autoclose:true
			});

		});
	</script>
	<script type="text/javascript">
		//上传图片
		var uploader = WebUploader.create({

			// 选完文件后，是否自动上传。
			auto: true,

			// swf文件路径
			swf: '__STATIC__/webuploader/Uploader.swf',

			// 文件接收服务端。
			server: "{:U('FinancialBank/upload_excel',array('session_id'=>session_id(), 'type'=>'overdue_resolve'))}",
			fileNumLimit: 1,
			// 选择文件的按钮。可选。
			// 内部根据当前运行是创建，可能是input元素，也可能是flash.
			pick: '#filePicker',
			resize : false,
			duplicate: true,
			// 只允许选择图片文件。
			accept: {
				title : 'Applications',
				extensions : 'xls',
				mimeTypes : 'application/xls'
			}
		});
		uploader.on( 'uploadSuccess', function(file, response) {
			upload(file, response);
		});

		function upload(file, data){

			if(data.status){
				updateAlert('导入成功','alert-success');
				//conosle.log(data.data);
				for(var i in data.data) {
					var line  = data.data[i];
					var add_html = '<tr>'+
							'<td>'+
							'<input type="text" class="input input-xmedium" name="logs1[]" value="'+line[0]+'">'+
							'</td>'+
							'<td>'+
							'<input type="text" class="input input-xmedium" name="logs2[]" value="'+line[1]+'">'+
							'</td>'+
							'<td>'+
							'<select name="logs3[]">{$area_options}</select>'+
							'</td>'+
							'<td>'+
							'<input type="text" class="input input-xmedium" name="logs4[]" value="'+line[3]+'">'+
							'</td>'+
							'<td>'+
							'<input type="text" class="input input-xmedium" name="logs5[]" value="'+line[4]+'">'+
							'</td>'+

							'<td>'+
							'<input type="text" class="input input-xmedium" name="logs6[]" value="'+line[5]+'">'+
							'</td>'+
							'<td><a class="btn del_log">删除</a></td>'+
							'</tr>'
					$('.add_line').before(add_html);

					$('.add_line').prev().find('select[name="logs3[]"]').val(line[2]);
				}

				if (data.key) {
					alert('部分数据不符合要求,我们将以excel的形式退回给您');
					window.open("{:U('get_excel')}/key/"+data.key);
				}



			} else {
				updateAlert(data.info);

			}
		}
	</script>
</block>